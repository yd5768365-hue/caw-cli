name: CAE-CLI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .

      - name: Run PR Review
        id: review
        run: |
          # ä½¿ç”¨Pythonè„šæœ¬è¿è¡ŒPRå®¡æŸ¥å·¥å…·å¹¶æå–çº¯JSONè¾“å‡º
          python << 'EOF' > review_report.json
          import subprocess
          import sys
          import json

          # è¿è¡ŒPRå®¡æŸ¥å·¥å…·
          result = subprocess.run(
              [sys.executable, '-m', 'sw_helper.utils.pr_review', '--branch', 'origin/main', '--output', 'json'],
              capture_output=True,
              text=True,
              encoding='utf-8'
          )

          # æå–JSONè¾“å‡ºï¼ˆå·¥å…·å¯èƒ½è¾“å‡ºæ—¥å¿—ä¿¡æ¯ï¼ŒJSONåœ¨æœ€åï¼‰
          output_lines = result.stdout.strip().split('\n')
          json_start = None

          # æŸ¥æ‰¾JSONå¼€å§‹ä½ç½®
          for i, line in enumerate(output_lines):
              line = line.strip()
              if line.startswith('{'):
                  json_start = i
                  break

          if json_start is not None:
              json_str = '\n'.join(output_lines[json_start:])
              try:
                  # éªŒè¯JSONæœ‰æ•ˆæ€§
                  json_data = json.loads(json_str)
                  # è¾“å‡ºçº¯JSON
                  print(json.dumps(json_data, ensure_ascii=False))
              except json.JSONDecodeError as e:
                  print(f"{{'error': 'JSONè§£æå¤±è´¥: {e}', 'raw_output': {json.dumps(result.stdout)}}}")
          else:
              # æ²¡æœ‰æ‰¾åˆ°JSONï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯
              print(json.dumps({
                  'error': 'æœªæ‰¾åˆ°JSONè¾“å‡º',
                  'stdout': result.stdout,
                  'stderr': result.stderr,
                  'returncode': result.returncode
              }))

          # ä¼ é€’é€€å‡ºçŠ¶æ€
          sys.exit(result.returncode)
          EOF

          # æ£€æŸ¥é€€å‡ºçŠ¶æ€ï¼ˆå¦‚æœæœ‰ä¸¥é‡é—®é¢˜ï¼Œå·¥å…·ä¼šè¿”å›1ï¼‰
          if [ $? -eq 1 ]; then
            echo "has_critical_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
          fi

          # è®¾ç½®è¾“å‡ºå˜é‡ç”¨äºä¸‹ä¸€æ­¥
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat review_report.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Review Results
        uses: actions/github-script@v7
        env:
          HAS_CRITICAL_ISSUES: ${{ steps.review.outputs.has_critical_issues }}
        with:
          script: |
            const report = JSON.parse(`${{ steps.review.outputs.report }}`);
            const issueCount = report.summary?.total_issues || 0;
            const criticalCount = report.summary?.critical_issues || 0;
            const highCount = report.summary?.high_issues || 0;

            // æ„å»ºMarkdownè¡¨æ ¼
            let issuesTable = '';
            if (issueCount > 0 && report.suggestions && report.suggestions.length > 0) {
              issuesTable = `| ä¸¥é‡ç¨‹åº¦ | æ–‡ä»¶ | é—®é¢˜æè¿° |\n|---|---|---|\n`;
              // åªæ˜¾ç¤ºä¸¥é‡å’Œé«˜ä¼˜å…ˆçº§é—®é¢˜
              const criticalAndHigh = report.suggestions.filter(s =>
                s.severity === 'critical' || s.severity === 'high'
              );

              criticalAndHigh.slice(0, 10).forEach(issue => {
                const fileDisplay = issue.file.split('/').slice(-2).join('/');
                const lineInfo = issue.line > 0 ? `:${issue.line}` : '';
                issuesTable += `| ${issue.severity.toUpperCase()} | \`${fileDisplay}${lineInfo}\` | ${issue.message} |\n`;
              });

              if (criticalAndHigh.length > 10) {
                issuesTable += `| ... | ... | è¿˜æœ‰ ${criticalAndHigh.length - 10} ä¸ªé—®é¢˜æœªæ˜¾ç¤º |\n`;
              }
            } else {
              issuesTable = 'âœ… æœªå‘ç°é—®é¢˜ï¼';
            }

            // æ„å»ºè¯„è®ºå†…å®¹
            const body = `## ğŸ¤– CAE-CLI è‡ªåŠ¨åŒ–å®¡æŸ¥æŠ¥å‘Š

            ### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
            - **å®¡æŸ¥æ–‡ä»¶**: ${report.summary?.reviewed_files || 0}/${report.summary?.total_files || 0}
            - **å‘ç°é—®é¢˜**: ${issueCount} ä¸ª
            - **ä¸¥é‡é—®é¢˜**: ${criticalCount} ä¸ª
            - **é«˜ä¼˜å…ˆçº§**: ${highCount} ä¸ª
            - **çŸ¥è¯†åº“æŸ¥è¯¢**: ${report.summary?.knowledge_queries || 0} æ¬¡ï¼ˆå‘½ä¸­: ${report.summary?.knowledge_hits || 0}ï¼‰

            ${criticalCount > 0 ? 'âš ï¸ **å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œè¯·ä¼˜å…ˆä¿®å¤ï¼**\n\n' : ''}

            ### ğŸ¯ ä¸»è¦é—®é¢˜
            ${issuesTable}

            ${issueCount > 0 ? `
            ### ğŸ’¡ å»ºè®®
            1. ä¿®å¤æ‰€æœ‰**ä¸¥é‡**å’Œ**é«˜ä¼˜å…ˆçº§**é—®é¢˜
            2. æŸ¥çœ‹å®Œæ•´æŠ¥å‘Šäº†è§£æ‰€æœ‰é—®é¢˜è¯¦æƒ…
            3. è¿è¡Œ \`cae-cli review --local\` åœ¨æœ¬åœ°éªŒè¯ä¿®å¤
            ` : ''}

            *æ­¤æŠ¥å‘Šç”± CAE-CLI PRå®¡æŸ¥å·¥å…·è‡ªåŠ¨ç”Ÿæˆ*`;

            // å‘å¸ƒè¯„è®º
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });