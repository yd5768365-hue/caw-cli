# Dependency Update Workflow
# Automated dependency checking and updates

name: Dependency Update

on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥æ£€æŸ¥
  workflow_dispatch:
  # å½“ pyproject.toml æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'pyproject.toml'

jobs:
  # æ£€æŸ¥ä¾èµ–æ›´æ–°
  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-tools
        run: |
          pip install pip-tools pip-audit

      - name: Generate requirements
        run: |
          pip-compile pyproject.toml --output-file=requirements-generated.txt || true

      - name: Audit dependencies
        run: |
          pip-audit || true

      - name: Check for outdated packages
        run: |
          pip list --outdated || true

      - name: Create issue if vulnerabilities found
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: vulns } = await github.request('GET /advisories');

            if (vulns.length > 0) {
              const body = `## âš ï¸ å®‰å…¨æ¼æ´è­¦å‘Š

æ£€æµ‹åˆ°ä»¥ä¸‹å®‰å…¨æ¼æ´:

${vulns.map(v => `- **${v.summary}**: ${v.description}`).join('\n')}

è¯·å°½å¿«æ›´æ–°ç›¸å…³ä¾èµ–ã€‚

---
*ç”± GitHub Actions è‡ªåŠ¨æ£€æµ‹*`;

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”’ å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š',
                body: body,
              });
            }
