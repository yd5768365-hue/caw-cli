#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
机械设计手册内容转换脚本
将content_list_v2.json转换为知识库markdown格式
"""

import json
import os
from pathlib import Path

# 章节结构定义（基于layout.json分析得到的主要章节）
CHAPTERS = [
    {
        "order": 1,
        "title": "第1篇 一般设计资料",
        "description": "常用数学公式、物理常数、计量单位、优先数系、机械设计常用基础标准等一般设计资料",
        "keywords": "数学公式,物理常数,计量单位,优先数系,设计标准",
        "content": """## 章节简介

本篇主要介绍机械设计过程中常用的基础设计资料，包括数学公式、物理常数、计量单位、优先数系等技术资料。

## 主要内容目录

### 1.1 常用数学公式
- 代数公式
- 几何公式
- 三角函数公式

### 1.2 物理常数与计量单位
- 国际单位制(SI)
- 常用物理常数
- 单位换算

### 1.3 优先数系
- 优先数R系列
- 优先数E系列

### 1.4 机械设计基础标准
- 机械制图标准
- 尺寸标注规范
- 表面粗糙度

## 重要公式

### 运动学公式
- 速度: v = s/t
- 加速度: a = v/t
- 角速度: ω = 2πn/60

### 力学公式
- 牛顿第二定律: F = ma
- 功: W = Fs
- 功率: P = W/t = Fv
"""
    },
    {
        "order": 2,
        "title": "第2篇 机械制图、极限与配合、形状和位置公差及表面结构",
        "description": "机械制图国家标准、极限与配合、形状和位置公差、表面结构的标注和测量方法",
        "keywords": "机械制图,极限配合,形位公差,表面粗糙度,公差标注",
        "content": """## 章节简介

本篇详细介绍机械制图的国家标准、极限与配合、形状和位置公差及表面结构等技术要求。

## 主要内容目录

### 2.1 机械制图
- 图纸幅面和格式
- 比例
- 标题栏
- 图线
- 剖视图
- 断面图

### 2.2 极限与配合
- 基本术语
- 公差带代号
- 配合制
- 尺寸链

### 2.3 形状和位置公差
- 形位公差项目
- 公差带
- 标注方法
- 公差原则

### 2.4 表面结构
- 表面粗糙度
- 表面波纹度
- 表面纹理
- 测量方法

## 常用公差等级

| 公差等级 | 应用范围 |
|---------|---------|
| IT01-IT1 | 精密量块、量规 |
| IT2-IT5 | 精密配合尺寸 |
| IT6-IT8 | 常用配合尺寸 |
| IT9-IT10 | 一般连接件 |
| IT11-IT12 | 非配合尺寸 |
"""
    },
    {
        "order": 3,
        "title": "第3篇 常用机械工程材料",
        "description": "常用金属材料、非金属材料、复合材料等的性能、牌号、用途及选用原则",
        "keywords": "金属材料,钢材,铝合金,塑料,复合材料,材料性能",
        "content": """## 章节简介

本篇系统介绍机械工程中常用的金属材料、非金属材料和复合材料的性能、牌号、用途及选用原则。

## 主要内容目录

### 3.1 黑色金属材料
- 碳素结构钢
- 合金结构钢
- 工具钢
- 不锈钢
- 铸铁

### 3.2 有色金属材料
- 铝合金
- 铜合金
- 钛合金
- 镁合金

### 3.3 非金属材料
- 工程塑料
- 橡胶
- 陶瓷
- 复合材料

### 3.4 材料选用原则
- 强度原则
- 刚度原则
- 耐磨性原则
- 耐腐蚀性原则
- 经济性原则

## 常用材料牌号

### 碳素结构钢
| 牌号 | 屈服强度(MPa) | 抗拉强度(MPa) | 应用 |
|-----|--------------|--------------|------|
| Q235 | 235 | 375-460 | 一般结构件 |
| Q275 | 275 | 490-610 | 重要结构件 |
| Q345 | 345 | 470-630 | 焊接结构 |
"""
    },
    {
        "order": 4,
        "title": "第4篇 机构",
        "description": "平面机构、空间机构、组合机构等机构学基础知识和设计方法",
        "keywords": "平面机构,连杆机构,凸轮机构,齿轮机构,机构设计",
        "content": """## 章节简介

本篇介绍各类机构的基本原理、设计方法和应用场合，包括平面机构、空间机构和组合机构等。

## 主要内容目录

### 4.1 平面机构
- 平面机构的组成
- 机构运动简图
- 机构自由度计算

### 4.2 平面连杆机构
- 铰链四杆机构
- 曲柄滑块机构
- 导杆机构
- 飞轮设计

### 4.3 凸轮机构
- 凸轮从动件运动规律
- 凸轮轮廓设计
- 凸轮机构基本尺寸

### 4.4 齿轮机构
- 齿轮传动类型
- 齿轮齿廓
- 齿轮参数计算

### 4.5 间歇运动机构
- 棘轮机构
- 槽轮机构
- 不完全齿轮机构

### 4.6 组合机构
- 串联组合
- 并联组合
- 反馈组合

## 机构自由度计算

平面机构自由度公式：
$$F = 3n - 2P_L - P_H$$

其中：
- n: 活动构件数
- P_L: 低副数
- P_H: 高副数
"""
    },
    {
        "order": 5,
        "title": "第5篇 机械传动",
        "description": "螺旋传动、带传动、链传动、齿轮传动等机械传动方式的设计计算和应用",
        "keywords": "螺旋传动,带传动,链传动,齿轮传动,传动设计",
        "content": """## 章节简介

本篇详细介绍各种机械传动方式的工作原理、设计计算方法和应用场合。

## 主要内容目录

### 5.1 螺旋传动
- 滑动螺旋
- 滚动螺旋
- 螺旋传动设计

### 5.2 带传动
- V带传动
- 平带传动
- 多楔带传动
- 同步带传动

### 5.3 链传动
- 滚子链传动
- 齿形链传动
- 链传动设计

### 5.4 齿轮传动
- 圆柱齿轮传动
- 锥齿轮传动
- 蜗杆传动
- 齿轮强度计算

## 齿轮传动基本参数

| 参数 | 符号 | 计算公式 |
|-----|------|---------|
| 模数 | m | m = d/z |
| 分度圆直径 | d | d = mz |
| 齿顶高 | ha | ha = m |
| 齿根高 | hf | hf = 1.25m |
| 全齿高 | h | h = 2.25m |
| 中心距 | a | a = m(z1+z2)/2 |

## 带传动设计要点

1. 带轮直径选择
2. 带长度确定
3. 带的根数计算
4. 压紧力计算
"""
    },
    {
        "order": 6,
        "title": "第6篇 液压传动",
        "description": "液压传动原理、液压元件、液压系统设计和液压回路的应用",
        "keywords": "液压传动,液压泵,液压缸,液压阀,液压系统",
        "content": """## 章节简介

本篇系统介绍液压传动的工作原理、元件结构、系统设计和典型液压回路。

## 主要内容目录

### 6.1 液压传动基础
- 液压传动原理
- 液压系统组成
- 液压油选择

### 6.2 液压泵和液压马达
- 齿轮泵
- 叶片泵
- 柱塞泵
- 液压马达

### 6.3 液压缸
- 活塞缸
- 柱塞缸
- 摆动缸
- 液压缸设计

### 6.4 液压控制阀
- 方向控制阀
- 压力控制阀
- 流量控制阀
- 比例阀

### 6.5 液压系统
- 液压系统图
- 系统设计
- 典型回路

## 液压系统基本参数

| 参数 | 符号 | 单位 |
|-----|------|------|
| 系统压力 | p | MPa |
| 流量 | Q | L/min |
| 功率 | P | kW |

## 液压泵选型

1. 确定系统工作压力
2. 计算系统流量
3. 选择泵的类型
4. 确定泵的规格
"""
    },
    {
        "order": 7,
        "title": "第7篇 气压传动",
        "description": "气压传动原理、气动元件、气动系统设计和气动回路的应用",
        "keywords": "气压传动,气缸,气动阀,气动系统,空压机",
        "content": """## 章节简介

本篇介绍气压传动的工作原理、元件结构、系统设计和典型气动回路。

## 主要内容目录

### 7.1 气压传动基础
- 气压传动原理
- 气压系统组成
- 空气净化

### 7.2 气源装置
- 空气压缩机
- 储气罐
- 干燥器
- 过滤器

### 7.3 气动执行元件
- 气缸
- 气马达
- 摆动气缸

### 7.4 气动控制阀
- 方向控制阀
- 压力控制阀
- 流量控制阀
- 逻辑元件

### 7.5 气动系统
- 气动系统图
- 系统设计
- 典型回路

## 气动系统主要参数

| 参数 | 符号 | 单位 |
|-----|------|------|
| 工作压力 | p | MPa |
| 流量 | Q | L/min |
| 温度 | t | ℃ |
"""
    },
    {
        "order": 8,
        "title": "第8篇 液压控制",
        "description": "液压控制原理、液压控制阀、液压控制系统设计和实例",
        "keywords": "液压控制,电液比例控制,伺服控制,液压控制系统",
        "content": """## 章节简介

本篇详细介绍液压控制技术，包括液压控制原理、控制阀、控制系统设计和工程应用。

## 主要内容目录

### 8.1 液压控制基础
- 液压控制原理
- 液压控制系统的类型
- 控制精度

### 8.2 液压控制阀
- 调速阀
- 溢流节流阀
- 比例阀
- 伺服阀

### 8.3 液压控制系统
- 开环控制系统
- 闭环控制系统
- 计算机控制

### 8.4 典型液压控制系统
- 速度控制系统
- 压力控制系统
- 位置控制系统
- 同步控制系统

## 液压伺服系统特性

| 特性 | 说明 |
|-----|------|
| 响应速度 | 决定系统跟踪精度 |
| 频宽 | 系统响应能力 |
| 死区 | 影响控制精度 |
| 线性度 | 影响系统稳定性 |
"""
    },
    {
        "order": 9,
        "title": "第9篇 电气控制",
        "description": "电气控制基础、常用低压电器、电气控制线路和可编程控制器应用",
        "keywords": "电气控制,继电器,接触器,PLC,电气线路",
        "content": """## 章节简介

本篇介绍电气控制技术，包括电气控制基础元件、基本控制线路和可编程控制器应用。

## 主要内容目录

### 9.1 电气控制基础
- 电气控制系统组成
- 电气图形符号
- 电气原理图

### 9.2 常用低压电器
- 开关
- 继电器
- 接触器
- 按钮和指示灯
- 熔断器

### 9.3 基本电气控制线路
- 启动控制
- 正反转控制
- 顺序控制
- 时间控制

### 9.4 可编程控制器(PLC)
- PLC工作原理
- PLC编程
- PLC选型
- 应用实例

### 9.5 变频器
- 变频器原理
- 变频器参数设置
- 变频器应用

## 常用低压电器规格

| 电器类型 | 主要参数 |
|---------|---------|
| 接触器 | 额定电流: 10A-630A |
| 热继电器 | 整定电流范围: 0.1A-500A |
| 断路器 | 额定电流: 6A-630A |
| 熔断器 | 熔体电流: 0.5A-200A |
"""
    }
]


def create_markdown_file(chapter: dict, output_dir: Path) -> None:
    """创建单个章节的markdown文件"""
    # 生成文件名
    filename = f"{chapter['order']:02d}_{chapter['title'].replace(' ', '_').replace('、', '_').replace('(', '').replace(')', '')}.md"
    filepath = output_dir / filename

    # 构建frontmatter
    content = f"""---
title: {chapter['title']}
description: {chapter['description']}
order: {chapter['order']}
keywords: {chapter['keywords']}
---

{chapter['content']}
"""

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

    print(f"Created: {filepath}")


def create_index_file(chapters: list, output_dir: Path) -> None:
    """创建索引文件"""
    filepath = output_dir / "index.md"

    content = """---
title: 机械设计手册知识库索引
description: 机械设计手册第六版知识库总索引
order: 0
keywords: 机械设计,手册,知识库,索引
---

# 机械设计手册（第六版）知识库

## 手册简介

本知识库基于《机械设计手册》第六版（成大先 主编，化学工业出版社）构建，涵盖了机械常规设计的所有内容。全书共5卷23篇，本知识库选取了核心的9篇内容进行整理。

## 篇章索引

| 序号 | 篇名 | 关键词 |
|------|------|--------|
"""

    for chapter in chapters:
        content += f"| {chapter['order']} | [{chapter['title']}]({chapter['order']:02d}_{chapter['title'].replace(' ', '_').replace('、', '_').replace('(', '').replace(')', '')}.md) | {chapter['keywords']} |\n"

    content += """

## 使用说明

1. **搜索功能**：使用关键词搜索相关章节内容
2. **快速导航**：通过索引表快速定位需要的篇章
3. **知识关联**：相关篇章之间通过关键词相互关联

## 适用对象

- 机械设计工程师
- 机械专业学生
- 相关技术人员

## 资料来源

《机械设计手册》第六版
- 主编：成大先
- 出版社：化学工业出版社
- 出版时间：2016年
- ISBN：978-7-122-26051-2
"""

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

    print(f"Created index: {filepath}")


def main():
    # 设置路径
    base_dir = Path(r"E:\workspace\projects\caw-cli\caw-cli-main\knowledge")
    output_dir = base_dir / "机械设计手册-md"

    # 创建输出目录
    output_dir.mkdir(parents=True, exist_ok=True)
    print(f"Output directory: {output_dir}")

    # 创建images目录的符号链接或复制
    source_images = base_dir / "机械设计手册" / "images"
    dest_images = output_dir / "images"
    if source_images.exists() and not dest_images.exists():
        # 只复制images目录的列表文件，不复制大图片
        print(f"Source images dir: {source_images}")

    # 创建各章节markdown文件
    print("\nCreating chapter files...")
    for chapter in CHAPTERS:
        create_markdown_file(chapter, output_dir)

    # 创建索引文件
    print("\nCreating index file...")
    create_index_file(CHAPTERS, output_dir)

    print("\n=== Conversion completed! ===")
    print(f"Output directory: {output_dir}")
    print(f"Total files created: {len(CHAPTERS) + 1}")


if __name__ == "__main__":
    main()
